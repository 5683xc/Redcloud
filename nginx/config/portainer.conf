upstream portainer {
    server portainer:9000;
}
# upstream red_msf-postresql {
#     server red_msf-postresql:4444;
# }
 

# Force http to https redirect
# Disable to allow unsecured http for portainer and files
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	server_name _;
	return 301 https://$host$request_uri;
}

server {

# Fetch certificates generated by omgwtfssl in the /cert/ volume
# Bind mount to host /tmp/cert
  listen 443 ssl http2;
        ssl_certificate /certs/cert.pem;
        ssl_certificate_key /certs/key.pem;
        ssl_session_timeout 5m;
        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers         HIGH:!aNULL:!MD5;

# Access the portainer web interface by going to https://IP/portainer
  location /portainer/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_pass http://portainer/;
  }

  location /portainer/api/websocket/ {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
      proxy_pass http://portainer/api/websocket/;
  }
# From https://github.com/portainer/portainer/issues/1887
# Fix upgrade token to connect to containers web consoles from reverse proxy
    location /wsapp/ {
        proxy_pass http://portainer;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

  location / {
    autoindex on;
     # Metasploit
    location ~ ^/update(.*) {
        resolver 127.0.0.11 valid=5s;
        set $target http://red_msf-postresql:4444;
        proxy_pass http://$target;
        }
    # Empire
    # location ~ ^/(admin/get.php|news.php|login/process.php|download/more.php) {
    #     proxy_pass http://127.0.0.1:1080;
    #     }
    }
}
